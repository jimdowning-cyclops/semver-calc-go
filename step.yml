title: Semantic Version Calculator
summary: Calculate semantic version from conventional commits in monorepos
description: |
  Calculates next semantic version based on git commit history using
  conventional commits with scope-based filtering for monorepo support.

  ## Features

  - **Scope-based filtering**: Filter commits by scope to calculate versions for specific products
  - **File-based detection**: Automatically detect affected products using file globs (config mode)
  - **Variant support**: Handle multiple build variants per product (e.g., mobile-customerA)
  - **Monorepo support**: Multiple products can share a commit history with independent versioning
  - **Conventional commits**: Parses `feat`, `fix`, and breaking changes to determine bump level

  ## Modes

  ### Legacy Mode (--product/--scopes)

  1. Finds the last git tag matching `{product}-v{semver}`
  2. Gets all commits since that tag
  3. Filters commits by the specified scopes
  4. Determines bump level (major/minor/patch/none) based on commit types
  5. Calculates and exports the next version

  ### Config Mode (.semver.yml)

  1. Reads product definitions with file globs and optional variants
  2. Uses git diff to detect which products are affected by each commit
  3. Filters variants based on commit scope
  4. Calculates versions for each product-variant combination

  ## Commit format

  The step recognizes conventional commit format:
  - `feat(scope):` triggers a minor bump
  - `fix(scope):` triggers a patch bump
  - `feat(scope)!:` or `BREAKING CHANGE:` in body triggers a major bump
  - Unscoped commits (e.g., `feat: ...`) match ALL products

  ## Tag format

  - Legacy mode: `{product}-v{version}` (e.g., `myapp-v1.2.3`)
  - Config mode with variants: `{product}-{variant}-v{version}` (e.g., `mobile-customerA-v1.2.3`)

website: https://github.com/jimdowning-cyclops/semver-calc-go
source_code_url: https://github.com/jimdowning-cyclops/semver-calc-go
support_url: https://github.com/jimdowning-cyclops/semver-calc-go/issues

type_tags:
  - utility

is_always_run: false
is_skippable: false

toolkit:
  go:
    package_name: github.com/jimdowning-cyclops/semver-calc-go

inputs:
  - product: ""
    opts:
      title: "Product name"
      summary: "Product name for tag prefix lookup (legacy mode)"
      description: |
        The product name used to find the last version tag.

        Tags are expected in the format `{product}-v{version}`.
        For example, if product is `myapp`, the step looks for tags like `myapp-v1.2.3`.

        Required for legacy mode. Not used if config file is present.
      is_required: false

  - scopes: ""
    opts:
      title: "Scopes"
      summary: "Comma-separated list of scopes to match (legacy mode)"
      description: |
        Comma-separated list of conventional commit scopes to include.

        For example: `myapp,app,core`

        - Commits with matching scopes are included in version calculation
        - Unscoped conventional commits (e.g., `feat: ...`) match ALL products
        - Non-conventional commits are ignored

        Required for legacy mode. Not used if config file is present.
      is_required: false

  - config: ".semver.yml"
    opts:
      title: "Config file path"
      summary: "Path to config file for file-based product detection"
      description: |
        Path to a YAML config file defining products, their file globs, and variants.

        Example config:
        ```yaml
        products:
          mobile:
            glob: "apps/mobile/**"
            variants: [customerA, customerB, internal]
          web:
            glob: "apps/web/**"
            variants: [customerA, customerB]
          sample-app:
            glob: "apps/sample/**"
            # No variants = single product mode
        ```
      is_required: false

  - config_content: ""
    opts:
      title: "Inline config content"
      summary: "Inline YAML config (takes precedence over config file path)"
      description: |
        Inline YAML config content. This takes precedence over the config file path,
        allowing you to define the config directly in your bitrise.yml.

        Example:
        ```yaml
        - git::https://github.com/jimdowning-cyclops/semver-calc-go.git@main:
            inputs:
              - config_content: |
                  products:
                    mobile:
                      glob: "apps/mobile/**"
                      variants: [customerA, customerB]
              - target: mobile-customerA
        ```
      is_required: false

  - target: ""
    opts:
      title: "Target product-variant"
      summary: "Specific product-variant to calculate (config mode)"
      description: |
        Calculate version for a specific product-variant.

        For example: `mobile-customerA` or `sample-app` (for products without variants)

        Required if using config mode and not using --all.
      is_required: false

outputs:
  - SEMVER_PRODUCT:
    opts:
      title: "Product name"
      summary: "The product name"

  - SEMVER_VARIANT:
    opts:
      title: "Variant name"
      summary: "The variant name (config mode only)"

  - SEMVER_TAG_NAME:
    opts:
      title: "Tag name prefix"
      summary: "The tag name prefix (e.g., mobile-customerA)"

  - SEMVER_CURRENT:
    opts:
      title: "Current version"
      summary: "Current version from last tag (or 0.0.0 if no tag exists)"

  - SEMVER_NEXT:
    opts:
      title: "Next version"
      summary: "Calculated next semantic version"

  - SEMVER_BUMP:
    opts:
      title: "Bump level"
      summary: "Version bump level: major, minor, patch, or none"

  - SEMVER_COMMITS:
    opts:
      title: "Commit count"
      summary: "Number of matching commits since last tag"

  - SEMVER_RESULTS:
    opts:
      title: "All results (JSON)"
      summary: "JSON array of all results when using --all (config mode)"
