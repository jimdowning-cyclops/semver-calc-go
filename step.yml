title: Semantic Version Calculator
summary: Calculate semantic version from conventional commits in monorepos
description: |
  Calculates next semantic version based on git commit history using
  conventional commits with file-based product detection for monorepo support.

  ## Features

  - **File-based detection**: Automatically detect affected products using file globs
  - **Multi-glob support**: Define multiple file patterns per product
  - **Variant support**: Handle multiple build variants per product (e.g., mobile-customerA)
  - **Monorepo support**: Multiple products can share a commit history with independent versioning
  - **Conventional commits**: Parses `feat`, `fix`, and breaking changes to determine bump level

  ## How It Works

  1. Reads product definitions with file globs and optional variants from config
  2. Uses git diff to detect which products are affected by each commit
  3. Filters variants based on commit scope (scopes only affect variant selection)
  4. Calculates versions for each product-variant combination

  ## Commit format

  The step recognizes conventional commit format:
  - `feat:` triggers a minor bump
  - `fix:` triggers a patch bump
  - `feat!:` or `BREAKING CHANGE:` in body triggers a major bump
  - Scopes (e.g., `feat(customerA):`) filter which variants are bumped

  ## Tag format

  - Products without variants: `{product}-v{version}` (e.g., `myapp-v1.2.3`)
  - Products with variants: `{product}-{variant}-v{version}` (e.g., `mobile-customerA-v1.2.3`)

website: https://github.com/jimdowning-cyclops/semver-calc-go
source_code_url: https://github.com/jimdowning-cyclops/semver-calc-go
support_url: https://github.com/jimdowning-cyclops/semver-calc-go/issues

type_tags:
  - utility

is_always_run: false
is_skippable: false

toolkit:
  go:
    package_name: github.com/jimdowning-cyclops/semver-calc-go

inputs:
  - config: ".semver.yml"
    opts:
      title: "Config file path"
      summary: "Path to config file for product detection"
      description: |
        Path to a YAML config file defining products, their file globs, and variants.

        Example config:
        ```yaml
        products:
          mobile:
            globs:
              - "apps/mobile/**"
              - "libs/mobile-common/**"
            variants: [customerA, customerB, internal]
          web:
            globs: ["apps/web/**"]
            variants: [customerA, customerB]
          sample-app:
            globs: ["apps/sample/**"]
            # No variants = single product mode
          my-lib:
            globs: ["**/*"]
            tag_prefix: v  # Use simple v* tags (v1.0.0) instead of my-lib-v1.0.0
        ```
      is_required: false

  - config_content: ""
    opts:
      title: "Inline config content"
      summary: "Inline YAML config (takes precedence over config file path)"
      description: |
        Inline YAML config content. This takes precedence over the config file path,
        allowing you to define the config directly in your bitrise.yml.

        Example:
        ```yaml
        - git::https://github.com/jimdowning-cyclops/semver-calc-go.git@main:
            inputs:
              - config_content: |
                  products:
                    mobile:
                      globs: ["apps/mobile/**", "libs/mobile-common/**"]
                      variants: [customerA, customerB]
              - target: mobile-customerA
        ```
      is_required: false

  - target: ""
    opts:
      title: "Target product-variant"
      summary: "Specific product-variant to calculate"
      description: |
        Calculate version for a specific product-variant.

        For example: `mobile-customerA` or `sample-app` (for products without variants)

        Either --target or --all is required.
      is_required: false

outputs:
  - SEMVER_PRODUCT:
    opts:
      title: "Product name"
      summary: "The product name"

  - SEMVER_VARIANT:
    opts:
      title: "Variant name"
      summary: "The variant name (config mode only)"

  - SEMVER_TAG_NAME:
    opts:
      title: "Tag name prefix"
      summary: "The tag name prefix (e.g., mobile-customerA)"

  - SEMVER_CURRENT:
    opts:
      title: "Current version"
      summary: "Current version from last tag (or 0.0.0 if no tag exists)"

  - SEMVER_NEXT:
    opts:
      title: "Next version"
      summary: "Calculated next semantic version"

  - SEMVER_BUMP:
    opts:
      title: "Bump level"
      summary: "Version bump level: major, minor, patch, or none"

  - SEMVER_COMMITS:
    opts:
      title: "Commit count"
      summary: "Number of matching commits since last tag"

  - SEMVER_RESULTS:
    opts:
      title: "All results (JSON)"
      summary: "JSON array of all results when using --all (config mode)"
